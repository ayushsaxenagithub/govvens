{% extends "base.html" %}
{% block title %}Select Seats - {{ event.name }}{% endblock %}

{% block content %}
<div style="width:100%;padding:0 20px;">
<div class="container my-5">

<!-- Header with Analytics -->
<div class="d-flex justify-content-between align-items-start mb-5">
    <div>
        <h1 class="mb-2"><i class="bi bi-cursor" style="color:#28a745;margin-right:10px;"></i>Select Your Seats</h1>
        <p class="text-muted-2" style="margin:0;">{{ event.name }} | ₹{{ event.ticket_price }} per seat</p>
    </div>
</div>

<!-- Real-time Analytics Grid -->
<div class="analytics-grid mb-5">
    <div class="metric-card">
        <div class="metric-icon"><i class="bi bi-chair"></i></div>
        <div class="metric-value">342</div>
        <div class="metric-title">Available Seats</div>
    </div>
    <div class="metric-card">
        <div class="metric-icon"><i class="bi bi-percent"></i></div>
        <div class="metric-value">67%</div>
        <div class="metric-title">Stadium Capacity Used</div>
    </div>
    <div class="metric-card">
        <div class="metric-icon"><i class="bi bi-hourglass-split"></i></div>
        <div class="metric-value">15 min</div>
        <div class="metric-title">Seat Hold Duration</div>
    </div>
    <div class="metric-card">
        <div class="metric-icon"><i class="bi bi-people"></i></div>
        <div class="metric-value">1,240</div>
        <div class="metric-title">Seats Sold Today</div>
    </div>
</div>

<!-- Availability by Section Chart -->
<div class="card card-dark shadow-strong mb-5">
    <div class="card-body">
        <h5 class="card-title mb-4"><i class="bi bi-graph-up" style="color:#28a745;margin-right:8px;"></i>Seat Availability by Block</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="graph-bar-container">
                    <div class="graph-label">Block A <span style="float:right;color:#28a745;font-weight:600;">145/180 (80%)</span></div>
                    <div class="progress" style="height:25px;">
                        <div class="progress-bar-animated" role="progressbar" style="width: 80%;" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div class="graph-bar-container">
                    <div class="graph-label">Block B <span style="float:right;color:#28a745;font-weight:600;">89/120 (74%)</span></div>
                    <div class="progress" style="height:25px;">
                        <div class="progress-bar-animated" role="progressbar" style="width: 74%;" aria-valuenow="74" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div class="graph-bar-container">
                    <div class="graph-label">Block C <span style="float:right;color:#28a745;font-weight:600;">108/200 (54%)</span></div>
                    <div class="progress" style="height:25px;">
                        <div class="progress-bar-animated" role="progressbar" style="width: 54%;" aria-valuenow="54" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex align-items-center justify-content-center" style="height:200px;">
                    <div class="text-center">
                        <div style="font-size:2.5rem;font-weight:700;color:#28a745;">342</div>
                        <div style="color:#b0b8c1;margin-top:10px;">Total Available Seats</div>
                        <div style="color:#b0b8c1;font-size:0.9rem;margin-top:5px;">Out of 500 total seats</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Insights -->
<div class="card card-dark shadow-strong mb-5">
    <div class="card-body">
        <h5 class="card-title mb-4"><i class="bi bi-lightning-charge" style="color:#20c997;margin-right:8px;"></i>Booking Insights</h5>
        <div class="row">
            <div class="col-md-4">
                <div class="stat-box">
                    <i class="bi bi-trending-up" style="font-size:1.5rem;color:#28a745;"></i>
                    <div class="stat-label" style="margin-top:12px;">Average Booking Time</div>
                    <div class="stat-value" style="margin-bottom:10px;">4.2 min</div>
                    <span class="stat-change positive"><i class="bi bi-arrow-down"></i> 12% faster than average</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-box">
                    <i class="bi bi-people" style="font-size:1.5rem;color:#20c997;"></i>
                    <div class="stat-label" style="margin-top:12px;">Group Size (Avg)</div>
                    <div class="stat-value" style="margin-bottom:10px;">2.3 seats</div>
                    <span class="stat-change positive"><i class="bi bi-arrow-up"></i> 18% increase this week</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-box">
                    <i class="bi bi-star-fill" style="font-size:1.5rem;color:#20c997;"></i>
                    <div class="stat-label" style="margin-top:12px;">Popular Blocks</div>
                    <div class="stat-value" style="margin-bottom:10px;">Block A</div>
                    <span class="stat-change positive"><i class="bi bi-award"></i> Most purchased section</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Instruction Alert -->
<div class="alert alert-info mb-4" style="border-left:4px solid #28a745;background:rgba(40,167,69,0.05);">
    <h6 style="color:#28a745;margin-bottom:12px;"><i class="bi bi-info-circle me-2"></i>How to Select Seats</h6>
    <ul class="mb-0" style="margin-left:0;padding-left:20px;">
        <li style="margin-bottom:8px;">Click available seats to select them (shown in outlined buttons)</li>
        <li style="margin-bottom:8px;">Selected seats will be highlighted in green</li>
        <li style="margin-bottom:8px;">Seats are held for 15 minutes during checkout</li>
        <li style="margin-bottom:8px;">You can select seats for yourself or your group</li>
        <li style="margin-bottom:8px;">Total price updates automatically as you select seats</li>
    </ul>
</div>

{% if not user.is_authenticated %}
<div class="alert alert-warning mb-4" style="border-left:4px solid #ffc107;background:rgba(255,193,7,0.05);">
    <i class="bi bi-exclamation-triangle me-2" style="color:#ffc107;"></i>
    <strong>Login Required:</strong> You can browse seats, but you'll need to <a href="{% url 'signup_login' %}" style="color:#ffc107;font-weight:600;">login</a> to complete your booking.
</div>
{% elif not user.is_verified %}
<div class="alert alert-warning mb-4" style="border-left:4px solid #ffc107;background:rgba(255,193,7,0.05);">
    <i class="bi bi-shield-exclamation me-2" style="color:#ffc107;"></i>
    <strong>Identity Verification Required:</strong> Please <a href="{% url 'verify_identity' %}" style="color:#ffc107;font-weight:600;">verify your identity</a> to complete booking.
</div>
{% endif %}

<!-- Seat Selection Map -->
<div class="card card-dark shadow-strong mb-5">
    <div class="card-header" style="background:linear-gradient(90deg,rgba(40,167,69,0.1),rgba(32,201,151,0.05));border:0;padding:20px;">
        <h5 class="mb-0"><i class="bi bi-grid-3x3" style="color:#28a745;margin-right:10px;"></i>Interactive Seat Map</h5>
    </div>
    <div class="card-body">
        <div class="row g-4">
            <div class="col-lg-8">
                <div style="background:rgba(255,255,255,0.02);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <h6 style="color:#28a745;margin-bottom:15px;"><i class="bi bi-chair-fill"></i> Block A</h6>
                            <div class="row g-1">
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-1-1" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-1-1">1-1</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-1-2" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-1-2">1-2</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-1-3" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-1-3">1-3</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-1-4" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-1-4">1-4</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-2-1" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-2-1">2-1</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-2-2" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-2-2">2-2</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-2-3" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-2-3">2-3</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-2-4" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-2-4">2-4</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-3-1" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-3-1">3-1</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-3-2" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-3-2">3-2</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-3-3" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-3-3">3-3</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-A-3-4" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-A-3-4">3-4</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 style="color:#20c997;margin-bottom:15px;"><i class="bi bi-chair-fill"></i> Block B</h6>
                            <div class="row g-1">
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-1-1" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-1-1">1-1</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-1-2" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-1-2">1-2</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-1-3" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-1-3">1-3</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-1-4" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-1-4">1-4</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-2-1" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-2-1">2-1</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-2-2" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-2-2">2-2</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-2-3" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-2-3">2-3</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-2-4" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-2-4">2-4</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-3-1" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-3-1">3-1</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-3-2" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-3-2">3-2</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-3-3" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-3-3">3-3</label>
                                        <input type="checkbox" class="btn-check" name="selected_seats" id="seat-B-3-4" autocomplete="off">
                                        <label class="btn btn-outline-light btn-sm" for="seat-B-3-4">3-4</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex;gap:20px;margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.03);">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div style="width:20px;height:20px;border:2px solid #b0b8c1;border-radius:4px;"></div>
                            <span style="color:#b0b8c1;font-size:0.9rem;">Available</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div style="width:20px;height:20px;background:linear-gradient(135deg,#28a745,#20c997);border-radius:4px;"></div>
                            <span style="color:#b0b8c1;font-size:0.9rem;">Selected</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div style="width:20px;height:20px;background:rgba(255,255,255,0.1);border-radius:4px;"></div>
                            <span style="color:#b0b8c1;font-size:0.9rem;">Unavailable</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div style="background:rgba(40,167,69,0.05);border:1px solid rgba(40,167,69,0.2);border-radius:12px;padding:20px;">
                    <h6 style="color:#28a745;margin-bottom:15px;"><i class="bi bi-receipt me-2"></i>Booking Summary</h6>
                    <form method="post" action="{% url 'seat_selection' event.id %}">
                        {% csrf_token %}
                        <div id="selectedSeatsInfo" style="display:none;margin-bottom:15px;">
                            <div style="padding:12px;background:rgba(32,201,151,0.1);border-radius:8px;border-left:3px solid #20c997;">
                                <div style="font-size:0.9rem;color:#b0b8c1;margin-bottom:8px;"><i class="bi bi-ticket-perforated me-2"></i>Selected Seats:</div>
                                <div style="color:#ffffff;font-weight:600;font-size:1.1rem;margin-bottom:12px;" id="selectedSeatsList"></div>
                                <div style="border-top:1px solid rgba(32,201,151,0.2);padding-top:12px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                        <span style="color:#b0b8c1;">Unit Price:</span>
                                        <span style="color:#ffffff;font-weight:600;">₹{{ event.ticket_price }}</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                        <span style="color:#b0b8c1;">Qty:</span>
                                        <span style="color:#ffffff;font-weight:600;" id="seatCount">0</span>
                                    </div>
                                    <div style="border-top:1px solid rgba(32,201,151,0.2);margin-top:12px;padding-top:12px;display:flex;justify-content:space-between;">
                                        <span style="color:#ffffff;font-weight:600;">Total:</span>
                                        <span style="color:#28a745;font-weight:700;font-size:1.2rem;">₹<span id="totalPrice">0</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-lg w-100" id="proceedBtn" disabled style="background:linear-gradient(90deg,#28a745,#20c997);color:#06110a;font-weight:600;border:0;margin-bottom:10px;">
                            <i class="bi bi-arrow-right-circle me-2"></i>Proceed to Payment
                        </button>
                        <a href="{% url 'event_detail' event.id %}" class="btn btn-outline-light btn-lg w-100" style="border:1px solid rgba(255,255,255,0.2);color:#b0b8c1;">
                            <i class="bi bi-arrow-left me-2"></i>Back
                        </a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Tips -->
<div class="card card-dark shadow-strong">
    <div class="card-body">
        <h5 class="card-title mb-4"><i class="bi bi-lightbulb" style="color:#20c997;margin-right:8px;"></i>Pro Tips for Best Experience</h5>
        <div class="row g-3">
            <div class="col-md-4">
                <div style="padding:15px;background:rgba(40,167,69,0.05);border-radius:10px;border-left:3px solid #28a745;">
                    <div style="font-weight:600;color:#28a745;margin-bottom:8px;"><i class="bi bi-clock me-2"></i>Book Early</div>
                    <p style="margin:0;color:#b0b8c1;font-size:0.9rem;">Best seats are filling up fast. Premium sections (Block A) have limited availability.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div style="padding:15px;background:rgba(32,201,151,0.05);border-radius:10px;border-left:3px solid #20c997;">
                    <div style="font-weight:600;color:#20c997;margin-bottom:8px;"><i class="bi bi-people me-2"></i>Group Bookings</div>
                    <p style="margin:0;color:#b0b8c1;font-size:0.9rem;">Select multiple seats to sit together. Make sure all group members are verified.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div style="padding:15px;background:rgba(32,201,151,0.05);border-radius:10px;border-left:3px solid #20c997;">
                    <div style="font-weight:600;color:#20c997;margin-bottom:8px;"><i class="bi bi-shield-check me-2"></i>Secure Purchase</div>
                    <p style="margin:0;color:#b0b8c1;font-size:0.9rem;">Your seats are held for 15 minutes. Complete checkout to confirm your booking.</p>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
</div>

<script>
    const ticketPrice = {{ event.ticket_price }};
    const selectedSeatsList = document.getElementById('selectedSeatsList');
    const totalPriceSpan = document.getElementById('totalPrice');
    const seatCountSpan = document.getElementById('seatCount');
    const selectedSeatsInfo = document.getElementById('selectedSeatsInfo');
    const proceedBtn = document.getElementById('proceedBtn');
    
    function updateSelection() {
        const selected = document.querySelectorAll('input[name="selected_seats"]:checked');
        const selectedSeats = Array.from(selected).map(cb => cb.id.replace('seat-', ''));
        const totalPrice = selected.length * ticketPrice;
        
        if (selected.length > 0) {
            selectedSeatsList.textContent = selectedSeats.join(', ');
            seatCountSpan.textContent = selected.length;
            totalPriceSpan.textContent = totalPrice.toLocaleString('en-IN');
            selectedSeatsInfo.style.display = 'block';
            proceedBtn.disabled = false;
        } else {
            selectedSeatsInfo.style.display = 'none';
            proceedBtn.disabled = true;
        }
    }
    
    document.querySelectorAll('input[name="selected_seats"]').forEach(el => {
        el.addEventListener('change', updateSelection);
    });
</script>
{% endblock %}